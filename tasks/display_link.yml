---

- name: DisplayLink
  block:


    - name: Ubuntu
      block:

        - name: Update apt cache
          apt:
            update_cache: yes
            cache_valid_time: 3600
          changed_when: no

        - name: Install prerequisite packages
          apt:
            name:
              - wget
              - dkms
              - linux-headers-generic
              - libdrm-dev
            state: present

        - name: "check if {{ display_link_ubuntu_package }} is installed"
          command: "dpkg-query -W -f='${Status}' {{ display_link_ubuntu_package }}"
          register: t_linux_display_link_status
          ignore_errors: yes
          changed_when: no

        - block:

            - name: Download synaptics repository keyring
              get_url:
                url: "{{ display_link_ubuntu_url }}"
                dest: "{{ tmpdir }}/{{ display_link_ubuntu_package }}.deb"
                mode: '0644'

            - name: Install the downloaded .deb package
              apt:
                deb: "{{ tmpdir }}/{{ display_link_ubuntu_package }}.deb"
                state: present

          when: (t_linux_display_link_status.rc != 0) or ('install ok installed' not in t_linux_display_link_status.stdout)

        - name: Update apt repositories
          apt:
            update_cache: yes
          changed_when: no

        - name: Install DisplayLink driver
          apt:
            name: "{{ display_link_package }}"
            state: present

        - name: Clean up downloaded .deb file
          file:
            path: "{{ tmpdir }}/{{ display_link_ubuntu_package }}.deb"
            state: absent

        # - name: Load DisplayLink module (optional - may require reboot)
        #   shell: displaylink-installer install
        #   changed_when: false

        # - name: mark reboot requested

        - name: Display completion message
          debug:
            msg: |
              DisplayLink installation complete!
              A system reboot may be required for the driver to work properly.

      when: ansible_distribution == 'Ubuntu'


  when: (want_display_link | d(false)) or (want_linux_display_link | d(false))
